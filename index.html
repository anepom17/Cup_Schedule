<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Расписание кубков с вероятностью прохода</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
    }
    body {
      font-family: inherit;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 0.8s linear infinite;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast-enter {
      animation: toast-in 0.3s ease-out forwards;
    }
    .toast-exit {
      animation: toast-out 0.25s ease-in forwards;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
    <h1 class="text-2xl sm:text-3xl font-semibold text-center sm:text-left text-gray-800 mb-6">
      Расписание кубков с вероятностью прохода
    </h1>

    <div class="mb-6">
      <button
        id="btn-refresh"
        type="button"
        class="w-full sm:w-auto min-h-[48px] px-8 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium text-base shadow-sm disabled:opacity-70 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
        aria-busy="false"
      >
        <span id="btn-text">Обновить расписание</span>
        <span id="btn-spinner" class="hidden" aria-hidden="true">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </span>
      </button>
    </div>

    <div
      id="results-container"
      class="rounded-2xl bg-white/80 shadow-sm border border-gray-300 overflow-hidden"
      role="region"
      aria-live="polite"
    >
      <div id="results-placeholder" class="py-12 px-4 text-center text-gray-500">
        Нет данных. Нажмите «Обновить расписание», чтобы загрузить.
      </div>
      <div id="results-timezone-bar" class="hidden border-b border-gray-200 px-3 py-2 bg-gray-50">
        <button type="button" id="btn-timezone" class="text-sm text-blue-600 hover:underline font-medium">Показать оригинальный часовой пояс (UTC)</button>
      </div>
      <div id="results-table-wrapper" class="hidden overflow-x-auto">
        <table id="results-table" class="w-full min-w-[640px] text-sm border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100/80 border-b border-gray-300">
              <th class="text-left py-3 px-3 font-medium text-gray-700 border-r border-gray-200">Время</th>
              <th class="text-left py-3 px-3 font-medium text-gray-700 border-r border-gray-200">Матч</th>
              <th class="text-left py-3 px-3 font-medium text-gray-700 border-r border-gray-200">Страна</th>
              <th class="text-left py-3 px-3 font-medium text-gray-700 border-r border-gray-200">Вероятность</th>
              <th class="text-left py-3 px-3 font-medium text-gray-700">Причина</th>
            </tr>
          </thead>
          <tbody id="results-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 max-w-sm pointer-events-none" aria-live="assertive"></div>

  <script>
    const WEBHOOK_URL = 'https://nepom.app.n8n.cloud/webhook/get-matches';

    const btnRefresh = document.getElementById('btn-refresh');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const resultsTimezoneBar = document.getElementById('results-timezone-bar');
    const resultsTableWrapper = document.getElementById('results-table-wrapper');
    const resultsTbody = document.getElementById('results-tbody');
    const toastContainer = document.getElementById('toast-container');

    let displayTimezone = 'msk';
    let currentScheduleData = [];

    function setLoading(loading) {
      btnRefresh.disabled = loading;
      btnRefresh.setAttribute('aria-busy', loading ? 'true' : 'false');
      btnText.textContent = loading ? 'Анализирую...' : 'Обновить расписание';
      btnSpinner.classList.toggle('hidden', !loading);
    }

    function getProbabilityClasses(probability) {
      const p = (probability || '').toLowerCase();
      if (p === 'high') return 'bg-green-100 text-green-800';
      if (p === 'medium') return 'bg-amber-100 text-amber-800';
      if (p === 'low') return 'bg-gray-100 text-gray-700';
      return 'bg-gray-50 text-gray-600';
    }

    function getTimeSlotClasses(count) {
      if (count > 4) return 'bg-red-200';
      if (count > 2) return 'bg-amber-200';
      return '';
    }

    function parseTimeAsUTC(timeStr) {
      if (!timeStr || typeof timeStr !== 'string') return null;
      const trimmed = timeStr.trim();
      const parts = trimmed.split(/\s+/);
      const datePart = parts[0] || '';
      const timePart = parts[1] || '00:00';
      const [d, m] = datePart.split('.');
      const [hour, min] = timePart.split(':');
      const day = parseInt(d, 10);
      const month = (parseInt(m, 10) || 1) - 1;
      const h = parseInt(hour, 10) || 0;
      const minu = parseInt(min, 10) || 0;
      if (isNaN(day) || isNaN(month) || month < 0 || month > 11) return null;
      const year = new Date().getFullYear();
      return new Date(Date.UTC(year, month, day, h, minu));
    }

    function formatTimeForDisplay(timeStr) {
      if (!timeStr || typeof timeStr !== 'string') return '';
      if (displayTimezone === 'original') return timeStr;
      const date = parseTimeAsUTC(timeStr);
      if (!date || isNaN(date.getTime())) return timeStr;
      const formatter = new Intl.DateTimeFormat('ru-RU', { timeZone: 'Europe/Moscow', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
      const p = formatter.formatToParts(date);
      const get = function (type) { return (p.find(function (x) { return x.type === type; }) || {}).value || ''; };
      return get('day') + '.' + get('month') + ' ' + get('hour') + ':' + get('minute');
    }

    function buildTimeCountMap(data) {
      const map = new Map();
      for (const row of data) {
        const key = row.human_time ?? row.time ?? '';
        map.set(key, (map.get(key) || 0) + 1);
      }
      return map;
    }

    function parseDateFromTime(timeStr) {
      if (!timeStr || typeof timeStr !== 'string') return null;
      const part = timeStr.trim().split(/\s+/)[0];
      if (!part) return null;
      const [d, m] = part.split('.');
      const day = parseInt(d, 10);
      const month = parseInt(m, 10) - 1;
      if (isNaN(day) || isNaN(month) || month < 0 || month > 11) return null;
      const year = new Date().getFullYear();
      return new Date(year, month, day);
    }

    function getDayLabel(timeStr) {
      const date = parseDateFromTime(timeStr);
      if (!date) return '\u0411\u0435\u0437 \u0434\u0430\u0442\u044b';
      const today = new Date();
      const sameDay = date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
      if (sameDay) return '\u0421\u0435\u0433\u043e\u0434\u043d\u044f';
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const isTomorrow = date.getDate() === tomorrow.getDate() && date.getMonth() === tomorrow.getMonth() && date.getFullYear() === tomorrow.getFullYear();
      if (isTomorrow) return '\u0417\u0430\u0432\u0442\u0440\u0430';
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      return dd + '.' + mm;
    }

    function groupByDay(data) {
      const groups = new Map();
      for (const row of data) {
        const time = row.human_time ?? row.time ?? '';
        const label = getDayLabel(time);
        if (!groups.has(label)) groups.set(label, []);
        groups.get(label).push(row);
      }
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const order = ['\u0421\u0435\u0433\u043e\u0434\u043d\u044f', '\u0417\u0430\u0432\u0442\u0440\u0430'];
      const other = Array.from(groups.keys()).filter(function (k) { return order.indexOf(k) === -1 && k !== '\u0411\u0435\u0437 \u0434\u0430\u0442\u044b'; });
      other.sort(function (a, b) {
        const da = parseDateFromTime(a.indexOf('.') !== -1 ? a + ' 00:00' : '01.01 00:00');
        const db = parseDateFromTime(b.indexOf('.') !== -1 ? b + ' 00:00' : '01.01 00:00');
        if (!da || !db) return 0;
        return da.getTime() - db.getTime();
      });
      const noDate = groups.has('\u0411\u0435\u0437 \u0434\u0430\u0442\u044b') ? ['\u0411\u0435\u0437 \u0434\u0430\u0442\u044b'] : [];
      const labels = order.filter(function (l) { return groups.has(l); }).concat(other).concat(noDate);
      return { labels: labels, groups: groups };
    }

    function updateTimezoneButtonText() {
      var btn = document.getElementById('btn-timezone');
      if (!btn) return;
      btn.textContent = displayTimezone === 'msk' ? 'Показать оригинальный часовой пояс (UTC)' : 'Показать московское время (МСК)';
    }

    function renderTable(data) {
      if (!Array.isArray(data) || data.length === 0) {
        resultsPlaceholder.classList.remove('hidden');
        resultsTimezoneBar.classList.add('hidden');
        resultsTableWrapper.classList.add('hidden');
        resultsPlaceholder.textContent = 'Нет данных. Нажмите «Обновить расписание», чтобы загрузить.';
        return;
      }

      currentScheduleData = data;
      resultsPlaceholder.classList.add('hidden');
      resultsTimezoneBar.classList.remove('hidden');
      resultsTableWrapper.classList.remove('hidden');
      updateTimezoneButtonText();

      const timeCountMap = buildTimeCountMap(data);
      const { labels, groups } = groupByDay(data);
      resultsTbody.innerHTML = '';

      for (let i = 0; i < labels.length; i++) {
        const label = labels[i];
        const rows = groups.get(label) || [];
        const isFirstGroup = i === 0;
        const dayHeaderTr = document.createElement('tr');
        dayHeaderTr.className = 'border-b border-gray-300';
        dayHeaderTr.innerHTML = '<td colspan="5" class="py-2 px-3 bg-gray-100 font-semibold text-gray-800 ' + (isFirstGroup ? '' : 'pt-4 ') + '">' + escapeHtml(label) + '</td>';
        resultsTbody.appendChild(dayHeaderTr);

        for (const row of rows) {
          const time = row.human_time ?? row.time ?? '';
          const count = timeCountMap.get(time) || 0;
          const timeSlotClass = getTimeSlotClasses(count);
          const probClass = getProbabilityClasses(row.probability);
          const timeDisplay = formatTimeForDisplay(time);

          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-200 hover:bg-gray-50/50';
          tr.innerHTML =
            '<td class="py-3 px-3 border-r border-gray-200 ' + timeSlotClass + '">' + escapeHtml(timeDisplay) + '</td>' +
            '<td class="py-3 px-3 border-r border-gray-200">' + escapeHtml(row.match ?? '') + '</td>' +
            '<td class="py-3 px-3 border-r border-gray-200">' + escapeHtml(row.country ?? '') + '</td>' +
            '<td class="py-3 px-3 border-r border-gray-200"><span class="inline-block px-2 py-1 rounded ' + probClass + '">' + escapeHtml(row.probability ?? '') + '</span></td>' +
            '<td class="py-3 px-3 text-gray-600">' + escapeHtml(row.reason ?? '') + '</td>';
          resultsTbody.appendChild(tr);
        }
      }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function showToast(message, isError = true) {
      const id = 'toast-' + Date.now();
      const el = document.createElement('div');
      el.id = id;
      el.className = 'toast-enter rounded-xl shadow-lg px-4 py-3 text-sm ' +
        (isError ? 'bg-red-50 border border-red-200 text-red-800' : 'bg-gray-100 border border-gray-200 text-gray-800');
      el.textContent = message;
      toastContainer.appendChild(el);

      setTimeout(() => {
        el.classList.remove('toast-enter');
        el.classList.add('toast-exit');
        setTimeout(() => el.remove(), 280);
      }, 5000);
    }

    async function fetchSchedule() {
      setLoading(true);
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/df955d71-8ea3-498b-9e20-43ed994afd94',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:fetchSchedule',message:'fetch start',data:{origin:location.origin,hasWebhookUrl:!!WEBHOOK_URL},timestamp:Date.now(),hypothesisId:'D'})}).catch(()=>{});
      // #endregion
      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/df955d71-8ea3-498b-9e20-43ed994afd94',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:afterFetch',message:'fetch completed',data:{ok:res.ok,status:res.status},timestamp:Date.now(),hypothesisId:'B'})}).catch(()=>{});
        // #endregion
        if (!res.ok) {
          throw new Error('Ошибка сети: ' + res.status + '. Проверьте URL webhook и подключение.');
        }
        const raw = await res.text();
        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          throw new Error('Не удалось разобрать ответ сервера.');
        }
        const list = Array.isArray(data) ? data : (data.data != null ? data.data : []);
        renderTable(list);
        localStorage.setItem('cup_schedule_cache', JSON.stringify(list));
      } catch (err) {
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/df955d71-8ea3-498b-9e20-43ed994afd94',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:catch',message:'fetch error',data:{name:err.name,message:err.message,origin:location.origin},timestamp:Date.now(),hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        const isCorsOrNetwork = (err.message === 'Failed to fetch' || err.name === 'TypeError') && location.origin !== 'file://';
        const msg = isCorsOrNetwork
          ? 'Запрос заблокирован (CORS). В n8n в ноде «Respond to Webhook» добавьте заголовок ответа: Access-Control-Allow-Origin = ' + location.origin
          : (err.message || 'Не удалось загрузить расписание. Проверьте подключение и URL webhook.');
        showToast(msg, true);
      } finally {
        setLoading(false);
      }
    }

    btnRefresh.addEventListener('click', fetchSchedule);

    document.getElementById('btn-timezone').addEventListener('click', function () {
      displayTimezone = displayTimezone === 'msk' ? 'original' : 'msk';
      if (currentScheduleData.length > 0) renderTable(currentScheduleData);
    });

    (function initSchedule() {
      const scheduleUrl = 'schedule.json';
      fetch(scheduleUrl)
        .then(function (res) {
          if (!res.ok) throw new Error('Not found');
          return res.json();
        })
        .then(function (data) {
          const list = Array.isArray(data) ? data : (data && data.data != null ? data.data : []);
          if (list.length > 0) renderTable(list);
          else throw new Error('Empty');
        })
        .catch(function () {
          try {
            const raw = localStorage.getItem('cup_schedule_cache');
            if (!raw) return;
            const cached = JSON.parse(raw);
            if (Array.isArray(cached) && cached.length > 0) renderTable(cached);
          } catch (_) {}
        });
    })();
  </script>
</body>
</html>
